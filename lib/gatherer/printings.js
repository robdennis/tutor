// Generated by CoffeeScript 1.7.1
(function() {
  var cheerio, extract, gatherer, iter, _;

  cheerio = require('cheerio');

  _ = require('underscore');

  gatherer = require('../gatherer');

  module.exports = function(details, callback) {
    gatherer.request(gatherer.card.url('Printings.aspx', details), function(err, res, body) {
      if (err) {
        return callback(err);
      } else {
        return callback(null, extract(body));
      }
    });
  };

  iter = function(row, fn) {
    var _results;
    _results = [];
    while (row.hasClass('cardItem')) {
      fn(row, _.map(row.children(), _.compose(gatherer._get_text, cheerio)));
      if (row.next() === row) {
        break;
      }
      _results.push(row = row.next());
    }
    return _results;
  };

  extract = function(html) {
    var $, data, prefix;
    $ = cheerio.load(html);
    data = {
      legality: {},
      versions: {}
    };
    prefix = '#ctl00_ctl00_ctl00_MainContent_SubContent_SubContent';
    iter($("" + prefix + "_PrintingsList_listRepeater_ctl00_cardTitle").parent().parent(), function(row, _arg) {
      var block, expansion, id, name, rarity, symbol, _ref;
      name = _arg[0], symbol = _arg[1], expansion = _arg[2], block = _arg[3];
      id = /\d+$/.exec(row.find('a').attr('href'))[0];
      _ref = /[(](.+)[)]/.exec(row.find('img').attr('alt')), rarity = _ref[_ref.length - 1];
      return data.versions[id] = {
        expansion: expansion,
        rarity: rarity
      };
    });
    iter($("" + prefix + "_LegalityList_listRepeater_ctl00_ConditionTableData").parent(), function(row, _arg) {
      var conditions, format, legality;
      format = _arg[0], legality = _arg[1], conditions = _arg[2];
      return data.legality[format] = legality === 'Special' ? "" + legality + ": " + conditions : legality;
    });
    return data;
  };

}).call(this);
